<div id="fusion-grid-injector-{{ block.id }}" class="fusion-grid-injector">
  <!-- This block works by detecting product cards and injecting the ATC icon -->
</div>

{% style %}
  .fusion-grid-atc-icon {
    position: absolute;
    z-index: 20;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: none;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    padding: 0;
    overflow: hidden;
  }
  .fusion-grid-atc-icon:hover {
    transform: scale(1.1);
  }
  .fusion-grid-atc-icon:active {
    transform: scale(0.9) !important;
  }

  /* Ripple Effect */
  .fusion-grid-atc-icon::after {
    content: "";
    display: block;
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    pointer-events: none;
    background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
    background-repeat: no-repeat;
    background-position: 50%;
    transform: scale(10, 10);
    opacity: 0;
    transition: transform 0.5s, opacity 1s;
  }
  .fusion-grid-atc-icon:active::after {
    transform: scale(0, 0);
    opacity: 0.3;
    transition: 0s;
  }
  .fusion-grid-atc-icon.is-loading {
    opacity: 0.7;
    cursor: wait;
  }
  .fusion-grid-atc-icon.is-success {
    background-color: {{ block.settings.success_color }} !important;
  }
  
  /* Ensure product cards have relative positioning so absolute icons work */
  {{ block.settings.card_selector }} {
    position: relative !important;
  }
{% endstyle %}

<script>
  (function() {
    const cardSelector = "{{ block.settings.card_selector }}";
    const iconSize = {{ block.settings.size }};
    const borderRadius = "{{ block.settings.border_radius }}%";
    const bgColor = "{{ block.settings.bg_color }}";
    const iconColor = "{{ block.settings.icon_color }}";
    const position = "{{ block.settings.position }}";

    function injectIcons() {
      const cards = document.querySelectorAll(cardSelector);
      
      cards.forEach(card => {
        if (card.querySelector('.fusion-grid-atc-icon')) return;

        // Try to find the product handle from a link inside the card
        const productLink = card.querySelector('a[href*="/products/"]');
        if (!productLink) return;

        const href = productLink.getAttribute('href');
        // Improved handle extraction to support query params and various characters
        const handleMatch = href.split('?')[0].match(/\/products\/([a-zA-Z0-9\-_]+)/);
        if (!handleMatch) return;
        const handle = handleMatch[1];

        // Create the icon button
        const btn = document.createElement('button');
        btn.className = 'fusion-grid-atc-icon';
        btn.style.width = iconSize + 'px';
        btn.style.height = iconSize + 'px';
        btn.style.borderRadius = borderRadius;
        btn.style.backgroundColor = bgColor;
        
        // Positioning
        if (position.includes('top')) btn.style.top = '10px';
        else btn.style.bottom = '10px';
        if (position.includes('right')) btn.style.right = '10px';
        else btn.style.left = '10px';

        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 60%; height: auto;">
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
          </svg>
        `;

        btn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          handleGridATC(handle, btn);
        };

        card.appendChild(btn);
      });
    }

    async function handleGridATC(handle, btn) {
      if (btn.classList.contains('is-loading') || btn.classList.contains('is-success')) return;
      
      const root = window.Shopify && window.Shopify.routes ? window.Shopify.routes.root : '/';
      const baseUrl = root.endsWith('/') ? root : root + '/';
      
      btn.classList.add('is-loading');

      try {
        // Fetch product data to get the first variant ID
        const response = await fetch(`${baseUrl}products/${handle}.js`);
        if (!response.ok) throw new Error('Product not found');
        const product = await response.json();
        const variantId = product.variants[0].id;

        console.log('Fusion Grid: Adding', { handle, variantId, baseUrl });

        // Add to cart
        const cartResponse = await fetch(baseUrl + 'cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 'items': [{ 'id': Number(variantId), 'quantity': 1 }] })
        });
        
        if (!cartResponse.ok) {
           const err = await cartResponse.json();
           throw err;
        }
        
        const cartData = await cartResponse.json();

        // Success state
        btn.classList.remove('is-loading');
        btn.classList.add('is-success');
        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="width: 60%; height: auto;">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        `;

        document.dispatchEvent(new CustomEvent('cart:updated', { detail: { cart: cartData } }));

        setTimeout(() => {
          btn.classList.remove('is-success');
          btn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 60%; height: auto;">
              <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <path d="M16 10a4 4 0 0 1-8 0"></path>
            </svg>
          `;
        }, 2000);

      } catch (error) {
        console.error('Fusion Grid ATC Error:', error);
        btn.classList.remove('is-loading');
        alert('Could not add to cart: ' + (error.description || error.message || 'Check stock'));
      }
    }

    // Run on load and on scroll (for infinite scroll collections)
    injectIcons();
    window.addEventListener('scroll', () => {
        // Debounce simple
        clearTimeout(window.fusionInjectTimeout);
        window.fusionInjectTimeout = setTimeout(injectIcons, 500);
    });
  })();
</script>

{% schema %}
{
  "name": "Grid ATC Injector",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Targeting"
    },
    { 
      "type": "text", 
      "id": "card_selector", 
      "label": "Product Card CSS Selector", 
      "default": ".card-wrapper",
      "info": "Common selectors: '.card-wrapper' (Dawn), '.product-card' (Sense/Craft), '.grid-view-item' (Debut). This is the element that wraps each product in the grid."
    },
    {
      "type": "header",
      "content": "Icon Style"
    },
    {
      "type": "select",
      "id": "position",
      "label": "Position",
      "options": [
        { "value": "top-right", "label": "Top Right" },
        { "value": "top-left", "label": "Top Left" },
        { "value": "bottom-right", "label": "Bottom Right" },
        { "value": "bottom-left", "label": "Bottom Left" }
      ],
      "default": "top-right"
    },
    { "type": "range", "id": "size", "min": 30, "max": 60, "step": 5, "unit": "px", "label": "Icon Size", "default": 40 },
    { "type": "range", "id": "border_radius", "min": 0, "max": 50, "step": 5, "unit": "%", "label": "Roundness", "default": 50 },
    { "type": "color", "id": "bg_color", "label": "Background Color", "default": "#ffffff" },
    { "type": "color", "id": "icon_color", "label": "Icon Color", "default": "#000000" },
    { "type": "color", "id": "success_color", "label": "Success Color", "default": "#4caf50" }
  ]
}
{% endschema %}

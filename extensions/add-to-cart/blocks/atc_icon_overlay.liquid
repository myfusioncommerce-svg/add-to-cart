{% assign product = block.settings.product | default: product %}

<div class="fusion-icon-overlay-container position-{{ block.settings.position }} {{ block.settings.animation }} {% if block.settings.enable_drag %}is-draggable{% endif %}" 
     id="fusion-icon-{{ block.id }}"
     style="{% if block.settings.enable_drag %}cursor: move;{% endif %} z-index: 2147483647 !important; display: block !important; visibility: visible !important;">
  <button type="button" 
          class="fusion-icon-atc-button"
          onclick="addIconToCart('{{ product.selected_or_first_available_variant.id }}', this)"
          style="background-color: {{ block.settings.bg_color }}; 
                 width: {{ block.settings.size }}px; 
                 height: {{ block.settings.size }}px;
                 border-radius: {{ block.settings.border_radius }}%;">
    
    {%- if block.settings.custom_icon != blank -%}
      <img src="{{ block.settings.custom_icon | image_url: width: 100 }}" 
           alt="Add to cart"
           style="width: {{ block.settings.icon_size }}%; height: auto; pointer-events: none;">
    {%- else -%}
      <svg viewBox="0 0 24 24" fill="none" stroke="{{ block.settings.icon_color }}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: {{ block.settings.icon_size }}%; height: auto; pointer-events: none;">
        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <path d="M16 10a4 4 0 0 1-8 0"></path>
      </svg>
    {%- endif -%}

    <div class="fusion-success-mark" style="background-color: {{ block.settings.success_color }};">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>

{% style %}
  .fusion-icon-overlay-container {
    position: fixed;
    margin: 20px;
    user-select: none;
    touch-action: none;
  }
  
  .position-top-right { top: 0; right: 0; }
  .position-top-left { top: 0; left: 0; }
  .position-bottom-right { bottom: 0; right: 0; }
  .position-bottom-left { bottom: 0; left: 0; }

  .fusion-icon-atc-button {
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    padding: 0;
    min-width: 44px;
    min-height: 44px;
    overflow: hidden;
  }
  .fusion-icon-atc-button:active {
    transform: scale(0.9);
  }

  /* Ripple Effect */
  .fusion-icon-atc-button::after {
    content: "";
    display: block;
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    pointer-events: none;
    background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
    background-repeat: no-repeat;
    background-position: 50%;
    transform: scale(10, 10);
    opacity: 0;
    transition: transform 0.5s, opacity 1s;
  }
  .fusion-icon-atc-button:active::after {
    transform: scale(0, 0);
    opacity: 0.3;
    transition: 0s;
  }

  .fusion-icon-overlay-container.is-dragging .fusion-icon-atc-button {
    transform: scale(1.1);
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
  }

  .fusion-success-mark {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: inherit;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.3s ease;
  }

  .fusion-icon-atc-button.is-success .fusion-success-mark {
    opacity: 1;
    transform: scale(1);
  }

  .fusion-float:not(.is-dragging) {
    animation: fusion-float 3s ease-in-out infinite;
  }
  @keyframes fusion-float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-5px); }
    100% { transform: translateY(0px); }
  }

  .fusion-pulse {
    animation: fusion-pulse-glow 2s infinite;
  }
  @keyframes fusion-pulse-glow {
    0% { box-shadow: 0 0 0 0 {{ block.settings.bg_color | color_modify: 'alpha', 0.4 }}; }
    70% { box-shadow: 0 0 0 10px {{ block.settings.bg_color | color_modify: 'alpha', 0 }}; }
    100% { box-shadow: 0 0 0 0 {{ block.settings.bg_color | color_modify: 'alpha', 0 }}; }
  }
{% endstyle %}

<script>
  (function() {
    const el = document.getElementById('fusion-icon-{{ block.id }}');
    const enableDrag = {{ block.settings.enable_drag | json }};
    let isDragging = false;
    let hasMoved = false;
    let startX, startY, initialLeft, initialTop;

    const screenKey = window.innerWidth < 768 ? 'mobile' : 'desktop';
    if (enableDrag) {
      const savedPos = localStorage.getItem(`fusion-pos-{{ block.id }}-${screenKey}`);
      if (savedPos) {
        try {
          const { left, top } = JSON.parse(savedPos);
          // Sanity check: Ensure the saved position is within visible bounds
          const l = parseFloat(left);
          const t = parseFloat(top);
          if (l >= 0 && l < window.innerWidth && t >= 0 && t < window.innerHeight) {
            el.style.left = left;
            el.style.top = top;
            el.classList.remove('position-top-right', 'position-top-left', 'position-bottom-right', 'position-bottom-left');
          }
        } catch(e) {}
      }
    }

    if (enableDrag) {
      el.addEventListener('mousedown', dragStart, { passive: false });
      el.addEventListener('touchstart', dragStart, { passive: false });
    }

    function dragStart(e) {
      isDragging = true;
      hasMoved = false;
      const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
      const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
      startX = clientX;
      startY = clientY;
      const rect = el.getBoundingClientRect();
      initialLeft = rect.left;
      initialTop = rect.top;
      
      document.addEventListener('mousemove', dragMove, { passive: false });
      document.addEventListener('mouseup', dragEnd);
      document.addEventListener('touchmove', dragMove, { passive: false });
      document.addEventListener('touchend', dragEnd);
    }

    function dragMove(e) {
      if (!isDragging) return;
      
      const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
      const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
      
      const dist = Math.sqrt(Math.pow(clientX - startX, 2) + Math.pow(clientY - startY, 2));
      
      if (dist > 5) {
        if (!hasMoved) {
          hasMoved = true;
          el.classList.add('is-dragging');
        }
        e.preventDefault();
        el.style.left = (initialLeft + (clientX - startX)) + 'px';
        el.style.top = (initialTop + (clientY - startY)) + 'px';
        el.classList.remove('position-top-right', 'position-top-left', 'position-bottom-right', 'position-bottom-left');
      }
    }

    function dragEnd() {
      if (!isDragging) return;
      isDragging = false;
      
      if (hasMoved) {
        // Short delay to prevent click if we actually moved
        setTimeout(() => el.classList.remove('is-dragging'), 100);
        localStorage.setItem(`fusion-pos-{{ block.id }}-${screenKey}`, JSON.stringify({
          left: el.style.left,
          top: el.style.top
        }));
      } else {
        el.classList.remove('is-dragging');
      }
      
      document.removeEventListener('mousemove', dragMove);
      document.removeEventListener('mouseup', dragEnd);
      document.removeEventListener('touchmove', dragMove);
      document.removeEventListener('touchend', dragEnd);
    }
  })();

  function addIconToCart(variantId, button) {
    if (!variantId || variantId === '') {
      console.error('Fusion Icon: No variant ID provided');
      return;
    }
    
    const vid = Number(variantId);
    if (!vid || vid <= 0) {
      console.error('Fusion Icon: Invalid variant ID', variantId);
      alert('Please select a valid product/variant first.');
      return;
    }
    
    const container = button.closest('.fusion-icon-overlay-container');
    // If the container has 'is-dragging', it means we just finished a real drag
    if (container.classList.contains('is-dragging')) {
      console.log('Fusion Icon: Blocked ATC because dragging');
      return;
    }
    
    if (button.classList.contains('is-success')) return;

    const root = window.Shopify && window.Shopify.routes ? window.Shopify.routes.root : '/';
    const baseUrl = root.endsWith('/') ? root : root + '/';

    console.log('Fusion Icon: Adding to cart...', { variantId: vid, baseUrl });

    let formData = { 'items': [{ 'id': vid, 'quantity': 1 }] };
    button.style.pointerEvents = 'none';
    button.style.opacity = '0.7';

    fetch(baseUrl + 'cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    })
    .then(response => {
      if (!response.ok) return response.json().then(e => { throw e; });
      return response.json();
    })
    .then(data => {
      console.log('Fusion Icon: Success', data);
      button.classList.add('is-success');
      button.style.opacity = '1';
      
      if (window.fusionRefreshCartUI) {
        window.fusionRefreshCartUI(data);
      } else {
        document.dispatchEvent(new CustomEvent('cart:updated', { detail: { cart: data } }));
        // Fallback refresh cart drawer
        if (window.location.pathname !== '/cart') {
          fetch(baseUrl + 'cart.js')
            .then(res => res.json())
            .then(cart => {
               document.dispatchEvent(new CustomEvent('cart:refresh', { detail: cart }));
            }).catch(() => {});
        }
      }

      setTimeout(() => {
        button.classList.remove('is-success');
        button.style.pointerEvents = 'auto';
      }, 2000);
    })
    .catch((error) => {
      console.error('Fusion Icon Error:', error);
      button.style.pointerEvents = 'auto';
      button.style.opacity = '1';
      alert('Could not add to cart: ' + (error.description || error.message || 'Check stock'));
    });
  }
</script>

{% schema %}
{
  "name": "Icon ATC Overlay",
  "target": "section",
  "settings": [
    { "type": "product", "id": "product", "label": "Product", "autofill": true },
    { "type": "checkbox", "id": "enable_drag", "label": "Enable Customer Drag", "default": true },
    { "type": "select", "id": "position", "label": "Position", "options": [{ "value": "top-right", "label": "Top Right" }, { "value": "top-left", "label": "Top Left" }, { "value": "bottom-right", "label": "Bottom Right" }, { "value": "bottom-left", "label": "Bottom Left" }], "default": "top-right" },
    { "type": "range", "id": "size", "min": 30, "max": 100, "step": 5, "unit": "px", "label": "Size", "default": 50 },
    { "type": "range", "id": "icon_size", "min": 30, "max": 80, "step": 5, "unit": "%", "label": "Icon Size", "default": 50 },
    { "type": "range", "id": "border_radius", "min": 0, "max": 50, "step": 5, "unit": "%", "label": "Roundness", "default": 50 },
    { "type": "color", "id": "bg_color", "label": "Background Color", "default": "#ffffff" },
    { "type": "color", "id": "icon_color", "label": "Icon Color", "default": "#000000" },
    { "type": "color", "id": "success_color", "label": "Success Color", "default": "#4caf50" },
    { "type": "image_picker", "id": "custom_icon", "label": "Custom Icon" },
    { "type": "select", "id": "animation", "label": "Animation", "options": [{ "value": "", "label": "None" }, { "value": "fusion-float", "label": "Floating" }, { "value": "fusion-pulse", "label": "Pulse" }], "default": "fusion-float" }
  ]
}
{% endschema %}
